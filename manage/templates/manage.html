{% load static %}

<!DOCTYPE html>
<html>
    <head>

		<meta charset="URF-8">
		<meta name = "viewport" content= "width = device-width", initial-scale="1">
		<title>커피탄 리 : 관리자</title>
		<link rel="stylesheet" href="{% static 'vendor/bootstrap/css/bootstrap.css' %}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>
		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
		<script src="{% static 'vendor/bootstrap/js/bootstrap.js' %}"></script>
    </head>
    <style>
        .nav-item > a:focus{
            color: red;
        }
        h3{
            text-align: center;
        }
        .box{
            background-color: #9d9d9d;
        }
        li{
            list-style: none;
        }
        table{
            text-align: center;
        }


    </style>
    <body>
    {% include 'nav.html' %}
<br>
    <div class="container-fluid">
        <div class="nav col-sm-2">
            <ul class="nav nav-tabs nav-stacked">
                <h3>Menu</h3>
                <li class="nav-item active in">
                    <a class="nav-link" data-toggle="tab" href="#tab-content-cctvManage" id="tab-cctvManage">
                        <i class="fas fa-video fa-lg"></i>&nbsp;CCTV 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " data-toggle="tab" href="#tab-content-userManage" id="tab-userManage" onclick="reaAllUser()">
                        <i class="fas fa-users fa-lg"></i>&nbsp;회원 관리</a>
                </li>
            </ul>
        </div>

        <div class="tab-content col-sm-8 col-sm-offset-1">
            <div class="tab-pane fade active in" id="tab-content-cctvManage">
                <h3>CCTV 관리</h3>
                <div class="box" style="background-color: white">


                 <div class="panel panel-primary">
                    <div class="panel-heading">CCTV 목록</div>
                    <div id = cctv_panel_body class="panel-body">
                    <table class="table"><thead><tr><td>Location</td><td>VideoLink</td><td>StartTime</td><td></td></tr></thead>
                        <tbody id="cctv_list_box">

                            {% for temp in qs %}
                                <tr>
                                    <td>{{temp.location}}</td>
                                    <td>{{temp.video_link}}</td>
                                    <td>{{temp.start_time}}</td>
                                    <td><input type="button" value="삭제" onclick="location.href = '{% url 'manage:delCctv' temp.id %}'"></td>
                                </tr>
                            {% endfor %}
                        </tbody></table>

                    </div>
                 </div>

                 <div style="background-color: #fff">
                    <form method = "post" action="{% url 'manage:manage' %}" enctype="multipart/form-data" style="background-color: #fff">
                        {% csrf_token %}
                        <input id=input_video type="file" name="video">
                        <button type="submit">Upload file</button>
                    </form>
                 </div>
                </div>
            </div>

            <div class="tab-pane fade in" id="tab-content-userManage">
                <h3>회원 관리</h3>
                <div class="panel panel-primary">
                    <div id="panel-heading" class="panel-heading">회원 목록</div>
                    <div id="panel-body" class="panel-body"></div>
                </div>
            </div>

        </div>
    </div>

    <br>
        {% include 'footer.html' %}

        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <script>alert("{{ message }}")</script>
                {% endfor %}
            </ul>
        {% endif %}

    <script>

        function reaAllUser() {
            $.ajax({
                url: 'reaAllUser',
                type: 'get',
                dataType: 'json',
                success:function (data) {
                    $('#panel-heading').html("회원 목록")
                    $('#panel-body').html('<table class="table"><thead><tr><td>아이디</td><td>이름</td><td>권한</td><td>회원 삭제</td></tr></thead>' +
                        '<tbody id="user_list_box"></tbody></table>');

                    for(var i in data) {
                        var user_list = document.createElement("tr");
                        user_list.innerHTML = '<td>' + data[i].username + '</td>' +
                                '<td>' + data[i].name + '</td>' +
                                '<td>' + '<select id="permission' + data[i].id + '" onchange="grantUser(' + data[i].id + ')">'
                        + '<option id="member' + data[i].id + '">' + 'member</option> <option id="admin' + data[i].id + '">' + 'admin</option>' + '</select>' + '</td>'
                        + '<td>' + '<input type="button" value="삭제" onclick="delUser(' + data[i].id + ')">'



                        $('#user_list_box').append(user_list);
                        if(data[i].permission == "member"){
                            $('#member'+data[i].id).attr("selected","selected");
                        }
                        else {
                            $('#admin'+data[i].id).attr("selected","selected");
                        }
                    }
                },
                error:function (xhr,error) {
                    alert("서버와의 통신에서 문제가 발생했습니다.");
                    console.error("error : " + error);
                }
            });
        }

        function delUser(id) {
            $.ajax({
                url: 'delUser',
                dataType: 'json',
                data:{
                  'id':id
                },
                type:'get',
                success:function (data) {
                    alert(data.data);
                    reaAllUser();
                },

                 error:function (xhr,error) {
                     alert("서버와의 통신에서 문제가 발생했습니다.");
                    console.error("error : " + error);
                }
            });
        }

        function grantUser(id) {
            $.ajax({
                url: 'grantUser',
                dataType:'json',
                data:{
                    'id':id,
                    'permission':$('#permission'+id).val()
                },
                type:'get',
                success: function (data) {
                    alert(data.data);

                },
                error: function (xhr,error) {
                    alert("서버와의 통신에서 문제가 발생했습니다.");
                    console.error("error : " + error);
                }

            });

        }
    </script>
	</body>
</html>