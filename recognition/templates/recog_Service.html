<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>커피탄 리 : 차량 인식</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'vendor/bootstrap/css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/service.css' %}">
    <link rel="stylesheet" type="text/css"
          href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500&display=swap" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" type="text/css" rel="stylesheet">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="{% static 'vendor/bootstrap/js/bootstrap.js' %}"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">

</head>

<body>
{% include 'nav.html' %}
<br>
<div class="container">
    <div class="row search-sec">
        <p class="text-right"><a class="btn btn-sm btn-primary" data-target="#recogModal"
                                 data-toggle="modal" onclick="setlayout()">검색하기</a></p>
    </div>
</div>

<div class="container">

    <div class="col-sm-2">
        <a class="btn btn-dark active" href="{% url 'recognition:recognition' %}" id="tab_button">
            <i class="fa fa-car fa-lg" style="margin-right: 5px;"></i> Recognition</a>
        <br>
        <a class="btn btn-dark" href="{% url 'statistic:statistic' %}" id="tab_button">
            <i class="fa fa-pie-chart fa-lg" aria-hidden="true" style="margin-right: 5px;"></i>
            <span style="margin-right: 15px;">Statistics</span></a>
    </div>

    <div class="col-sm-6">
        <video id="video" controls onplay="startAlert()" onpause="stopAlert()">
            <source src="{% static 'videos/minchan.mp4' %}">
        </video>
    </div>

    <div id="car_list_box" class="col-sm-4" style="text-align:center; height: 300px;">

    </div>
</div>

<br>

<div class="row">
    <div class="modal" id="recogModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    차량 인식 서비스
                    <button class="close" data-dismiss="modal">&times;</button>
                </div>

                <form action="/recognition/recog/" method="POST">
                    {% csrf_token %}
                    <div class="modal-body" style="width:550px;height:480px;text-align: center;">
                        <div class="col-sm-4">
                            <span style="font-weight: bolder; font-size: 15px;">시작 시간</span>
                            <input id="recognition_start_time" type="text" name="start_time" width="180"
                                   style="margin-bottom: 15px" readonly/>
                        </div>

                        <div class="col-sm-4">
                            <span style="font-weight: bolder; font-size: 15px;" style="margin-bottom: 15px">종료 시간</span>
                            <input id="recognition_end_time" type="text" name="end_time" width="180"
                                   style="margin-bottom: 15px" readonly/>
                        </div>

                        <div class="col-sm-4">
                            <span style="font-weight: bolder; font-size: 15px;" style="margin-bottom: 15px">위치</span>
                            <input id="recognition_location" name="location" width="180" value=""
                                   style="margin-bottom: 15px" readonly>
                        </div>

                        <div id="recognition_map" style="width:565px;height:350px;"></div>

                        <div class="btn-area">
                            <button id="btn" type="submit">제출</button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include 'footer.html' %}

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a8a08365e71499493906a12ac8f92432"></script>
<script>
    {#startAlert = function () {#}
    {#    var video = document.getElementById("video");#}
    {#    video_time_sec = parseInt(video.currentTime.toFixed(0)) % 60;#}
    {#    video_time_min = parseInt(parseInt(video.currentTime.toFixed(0)) / 60);#}
    {#    x = {{ cctv_log.0.appearance_time.second }} +video_time_sec;#}
    {#    y = {{ cctv_log.0.appearance_time.minute }} +video_time_min;#}
    {##}
    {#    if (x == {{ cctv_log.0.appearance_time.second }} && y =={{ cctv_log.0.appearance_time.minute }}) {#}
    {#        var car_list = document.createElement("li");#}
    {##}
    {#        car_list.innerHTML = '{{ cctv_log.0.color }}' + ' ' + '{{ cctv_log.0.car_model.model }}' + ' ' + '{{ cctv_log.0.appearance_time }}'#}
    {#        $('#car_list_box').append(car_list);#}
    {##}
    {#    }#}
    {##}
    {#    playAlert = setInterval(function () {#}
    {#        var video = document.getElementById("video");#}
    {#        video_time_sec = parseInt(video.currentTime.toFixed(0)) % 60;#}
    {#        video_time_min = parseInt(parseInt(video.currentTime.toFixed(0)) / 60);#}
    {#        x = {{ cctv_log.0.appearance_time.second }} +video_time_sec;#}
    {#        y = {{ cctv_log.0.appearance_time.minute }} +video_time_min;#}
    {##}
    {#        {% for log in cctv_log %}#}
    {##}
    {#            if (x == {{ log.appearance_time.second }} && y == {{ log.appearance_time.minute }}) {#}
    {#                var car_list = document.createElement("li");#}
    {##}
    {#                car_list.innerHTML = car_list.innerHTML = '{{ log.color }}' + ' ' + '{{ log.car_model.model }}' + ' ' + '{{ log.appearance_time }}'#}
    {##}
    {#                $('#car_list_box').append(car_list);#}
    {##}
    {#            }#}
    {#        {% endfor %}#}
    {#    }, 1000);#}
    {
        #};
        #}
        {#stopAlert = function () {#}
        {#    clearInterval(playAlert);#}
        {
            #};
            #}

            var recognition_container = document.getElementById('recognition_map');

            var options = {
                center: new kakao.maps.LatLng(37.549341, 127.0742582),
                level: 3
            };

            var recognition_map = new kakao.maps.Map(recognition_container, options);

            function setlayout() {
                setTimeout(function () {
                        recognition_map.relayout();
                    }
                    , 0);
            }

            var cctv_obj = "{{ cctv }}".replace(/&quot;/g, '"');
            var cctv_json = JSON.parse(cctv_obj);

            // 마커 이미지의 이미지 주소입니다
            var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

            var positions = [
                {% for i in count %}
                    {
                        title: cctv_json[{{i}}].fields.location,
                        latlng: new kakao.maps.LatLng(cctv_json[{{i}}].fields.latitude, cctv_json[{{i}}].fields.longtitude)
                    },
                {% endfor %}
            ];

            for (var i = 0; i < positions.length; i++) {

                var imageSize = new kakao.maps.Size(24, 35);

                // 마커를 생성합니다
                var recognition_marker = new kakao.maps.Marker({
                    map: recognition_map, // 마커를 표시할 지도
                    position: positions[i].latlng, // 마커를 표시할 위치
                    title: positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                    clickable: true
                });

                var infowindow = new kakao.maps.InfoWindow({
                    content: positions[i].title // 인포윈도우에 표시할 내용
                });

                kakao.maps.event.addListener(recognition_marker, 'click', get_location(positions[i].title));
                kakao.maps.event.addListener(recognition_marker, 'mouseover', makeOverListener(recognition_map, recognition_marker, infowindow));
                kakao.maps.event.addListener(recognition_marker, 'mouseout', makeOutListener(infowindow));
            }

            // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
            function makeOverListener(map, marker, infowindow) {
                return function () {
                    infowindow.open(map, marker);
                };
            }

            // 인포윈도우를 닫는 클로저를 만드는 함수입니다
            function makeOutListener(infowindow) {
                return function () {
                    infowindow.close();
                };
            }

            function get_location(info) {
                return function () {
                    document.getElementById("recognition_location").value = info;
                };
            }

            $(function () {
                $('#recognition_start_time').datetimepicker({
                    format: 'YYYY-MM-DD HH:mm:ss',
                    ignoreReadonly: true
                });
            });

            $(function () {
                $('#recognition_end_time').datetimepicker({
                    format: 'YYYY-MM-DD HH:mm:ss',
                    ignoreReadonly: true
                });
            });

</script>
</body>
</html>

